define(["jquery","core/ajax","core/notification"],function($,ajax,notification){var courseId,chatWindow,chatButton,messagesArea,input,sendButton,typingIndicator,closeButton;var showTyping=function(){typingIndicator.hidden=false;messagesArea.scrollTop=messagesArea.scrollHeight};var hideTyping=function(){typingIndicator.hidden=true};var addMessage=function(content,type){type=type||"bot";var msgDiv=document.createElement("div");msgDiv.classList.add("ai-message","ai-message-"+type);msgDiv.textContent=content;messagesArea.appendChild(msgDiv);messagesArea.scrollTop=messagesArea.scrollHeight;return msgDiv};var addFeedbackButtons=function(logId,messageElement){var feedbackDiv=document.createElement("div");feedbackDiv.classList.add("ai-feedback");var helpfulBtn=document.createElement("button");helpfulBtn.classList.add("ai-feedback-btn");helpfulBtn.innerText="üëç";helpfulBtn.dataset.logid=logId;helpfulBtn.dataset.helpful="1";var notHelpfulBtn=document.createElement("button");notHelpfulBtn.classList.add("ai-feedback-btn");notHelpfulBtn.innerText="üëé";notHelpfulBtn.dataset.logid=logId;notHelpfulBtn.dataset.helpful="0";feedbackDiv.appendChild(helpfulBtn);feedbackDiv.appendChild(notHelpfulBtn);messageElement.appendChild(feedbackDiv)};var toggleChat=function(){var isHidden=chatWindow.hidden;chatWindow.hidden=!isHidden;chatButton.hidden=isHidden;if(isHidden){input.focus()}};var onSendClick=function(){var question=input.value.trim();if(question===""){return}console.log("[AI Assistant] Sending question:",question);console.log("[AI Assistant] Input disabled:",input.disabled);addMessage(question,"user");input.value="";input.disabled=true;sendButton.disabled=true;showTyping();ajax.call([{methodname:"local_aiassistant_query",args:{courseid:courseId,question:question},done:function(response){console.log("[AI Assistant] Response received:",response);var messageEl=addMessage(response.answer,"bot");addFeedbackButtons(response.log_id,messageEl)},fail:function(ex){console.error("[AI Assistant] AJAX failed:",ex);notification.exception(ex);addMessage("Sorry, I am having trouble connecting.","bot")},always:function(){console.log("[AI Assistant] Always callback executed - re-enabling input");hideTyping();input.disabled=false;sendButton.disabled=false;console.log("[AI Assistant] Input re-enabled:",!input.disabled);input.focus()}}])};var onFeedbackClick=function(e){var target=e.target.closest(".ai-feedback-btn");if(!target){return}var parent=target.parentElement;parent.querySelectorAll(".ai-feedback-btn").forEach(function(btn){btn.disabled=true;btn.classList.remove("active")});target.classList.add("active");ajax.call([{methodname:"local_aiassistant_feedback",args:{logid:parseInt(target.dataset.logid),helpful:target.dataset.helpful==="1"},done:function(){},fail:notification.exception}])};return{init:function(params){courseId=params.courseid;chatWindow=document.getElementById("ai-chat-window");chatButton=document.getElementById("ai-chat-button");messagesArea=document.getElementById("ai-chat-messages");input=document.getElementById("ai-chat-input");sendButton=document.getElementById("ai-chat-send");typingIndicator=document.getElementById("ai-chat-typing");closeButton=document.getElementById("ai-chat-close");if(!chatWindow){return}chatButton.addEventListener("click",toggleChat);closeButton.addEventListener("click",toggleChat);sendButton.addEventListener("click",onSendClick);input.addEventListener("keypress",function(e){if(e.key==="Enter"){onSendClick()}});messagesArea.addEventListener("click",onFeedbackClick)}}});
